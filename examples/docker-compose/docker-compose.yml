version: '3.8'

services:
  # JupyterLab service / JupyterLab 服务
  jupyter:
    image: ${ATLAS_IMAGE:-atlas:v0.6-base}
    container_name: atlas-jupyter
    ports:
      - "${JUPYTER_PORT:-8888}:8888"
    volumes:
      - ./notebooks:/workspace/notebooks
      - ./data:/workspace/data
    working_dir: /workspace
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - JUPYTER_TOKEN=${JUPYTER_TOKEN:-atlas}
    command: >
      jupyter lab
      --ip=0.0.0.0
      --port=8888
      --no-browser
      --allow-root
      --NotebookApp.token=${JUPYTER_TOKEN:-atlas}
    # GPU configuration (Docker Compose v2.3+) / GPU 配置
    # Note: 'deploy' syntax is for Swarm. For standalone docker-compose,
    # GPU access works but configuration may be ignored.
    # 注意：'deploy' 语法用于 Swarm。在独立 docker-compose 中，
    # GPU 访问有效但配置可能被忽略。
    # Alternative: Use 'runtime: nvidia' for older docker-compose versions
    # 替代方案：对于旧版 docker-compose，使用 'runtime: nvidia'
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ${GPU_DEVICES:-all}
              capabilities: [gpu]
    restart: unless-stopped
    networks:
      - atlas-network

  # Development environment / 开发环境
  dev:
    image: ${ATLAS_IMAGE:-atlas:v0.6-base}
    container_name: atlas-dev
    volumes:
      - ${HOST_WORKSPACE:-./workspace}:/workspace
      - ./data:/data
    working_dir: /workspace
    command: /bin/bash
    stdin_open: true
    tty: true
    # GPU configuration / GPU 配置
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ${GPU_DEVICES:-all}
              capabilities: [gpu]
    networks:
      - atlas-network

networks:
  atlas-network:
    driver: bridge
