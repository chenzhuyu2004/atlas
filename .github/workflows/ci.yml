name: ATLAS CI/CD

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main]
    paths:
      - 'docker/atlas/Dockerfile'
      - 'docker/atlas/.dockerignore'
      - 'docker/atlas/.env.example'
      - 'docker/atlas/Makefile'
      - 'docker/atlas/VERSION'
      - 'docker/atlas/*.sh'
      - 'docker/atlas/requirements*.txt'
      - 'docker/atlas/scripts/**'
      - 'docker/atlas/tests/**'
      - 'tests/**'
      - '.github/workflows/**'
      - '.pre-commit-config.yaml'
      - '.hadolint.yaml'
      - 'mypy.ini'
      - '*.sh'
      - 'examples/**'
      - 'projects/**'
    tags:
      - 'v*'
  pull_request:
    branches: [main]
    paths:
      - 'docker/atlas/Dockerfile'
      - 'docker/atlas/.dockerignore'
      - 'docker/atlas/.env.example'
      - 'docker/atlas/Makefile'
      - 'docker/atlas/VERSION'
      - 'docker/atlas/*.sh'
      - 'docker/atlas/requirements*.txt'
      - 'docker/atlas/scripts/**'
      - 'docker/atlas/tests/**'
      - 'tests/**'
      - '.github/workflows/**'
      - '.pre-commit-config.yaml'
      - '.hadolint.yaml'
      - 'mypy.ini'
      - '*.sh'
      - 'examples/**'
      - 'projects/**'
  workflow_dispatch:

env:
  IMAGE_NAME: atlas
  REGISTRY: ghcr.io

jobs:
  changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
      docker: ${{ steps.filter.outputs.docker }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect path changes / å˜æ›´è·¯å¾„æ£€æµ‹
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            code:
              - 'docker/atlas/Dockerfile'
              - 'docker/atlas/requirements*.txt'
              - 'docker/atlas/scripts/**'
              - 'docker/atlas/tests/**'
              - 'docker/atlas/VERSION'
              - 'tests/**'
              - '.github/workflows/**'
              - '.pre-commit-config.yaml'
              - '.hadolint.yaml'
              - 'mypy.ini'
              - '*.sh'
            docker:
              - 'docker/atlas/Dockerfile'
              - 'docker/atlas/requirements*.txt'
              - 'docker/atlas/scripts/**'
              - 'docker/atlas/tests/**'
              - 'docker/atlas/VERSION'
              - '.hadolint.yaml'
              - '.github/workflows/ci.yml'
              - '.github/workflows/nightly-build.yml'

      - name: Summary / å˜æ›´æ‘˜è¦
        run: |
          echo "## CI change detection" >> "$GITHUB_STEP_SUMMARY"
          echo "- code changes: \`${{ steps.filter.outputs.code }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- docker changes: \`${{ steps.filter.outputs.docker }}\`" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.filter.outputs.code }}" != "true" ]; then
            echo "- tests: skipped (no code changes)" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- tests: will run" >> "$GITHUB_STEP_SUMMARY"
          fi

  # Fast checks for every PR/push / å¿«é€Ÿæ£€æŸ¥ï¼ˆæ¯æ¬¡ PR/pushï¼‰
  lint:
    needs: [changes]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      matrix:
        python-version: ['3.12']
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python for pre-commit
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Compute pre-commit args
        id: precommit_args
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "args=--from-ref ${{ github.event.pull_request.base.sha }} --to-ref ${{ github.event.pull_request.head.sha }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          BEFORE="${{ github.event.before }}"
          SHA="${{ github.sha }}"
          if [ -z "$BEFORE" ] || [ "$BEFORE" = "0000000000000000000000000000000000000000" ]; then
            echo "args=--all-files" >> "$GITHUB_OUTPUT"
          else
            echo "args=--from-ref $BEFORE --to-ref $SHA" >> "$GITHUB_OUTPUT"
          fi

      - name: Run pre-commit
        uses: pre-commit/action@v3.0.1
        env:
          SKIP: hadolint-docker,pytest
        with:
          extra_args: ${{ steps.precommit_args.outputs.args }}

      - name: Install hadolint / å®‰è£… hadolint
        if: needs.changes.outputs.docker == 'true'
        run: |
          HADOLINT_VERSION=v2.12.0
          mkdir -p ~/.local/bin
          curl -sSL \
            "https://github.com/hadolint/hadolint/releases/download/${HADOLINT_VERSION}/hadolint-Linux-x86_64" \
            -o ~/.local/bin/hadolint
          chmod +x ~/.local/bin/hadolint
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Hadolint Dockerfile / Dockerfile é™æ€æ£€æŸ¥
        if: needs.changes.outputs.docker == 'true'
        run: |
          hadolint --config .hadolint.yaml --failure-threshold warning docker/atlas/Dockerfile

      - name: Set up Docker Buildx
        if: needs.changes.outputs.docker == 'true'
        uses: docker/setup-buildx-action@v3

      - name: Smoke build Dockerfile / è½»é‡æ„å»ºæ ¡éªŒ
        if: needs.changes.outputs.docker == 'true'
        uses: docker/build-push-action@v5
        with:
          context: docker/atlas
          file: docker/atlas/Dockerfile
          load: true
          tags: atlas:smoke
          target: smoke
          cache-from: type=gha,scope=smoke
          cache-to: type=gha,mode=max,scope=smoke

      - name: Trivy scan (PR) / Trivy æ‰«æï¼ˆPRï¼‰
        if: needs.changes.outputs.docker == 'true' && github.event_name == 'pull_request'
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: atlas:smoke
          format: 'json'
          output: trivy-pr.json
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Trivy scan (PR, SARIF) / Trivy æ‰«æï¼ˆPR, SARIFï¼‰
        if: needs.changes.outputs.docker == 'true' && github.event_name == 'pull_request'
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: atlas:smoke
          format: 'sarif'
          output: trivy-pr.sarif
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true
          exit-code: '0'

      - name: Fail on high severity findings (PR) / é«˜å±å³é˜»æ–­
        if: needs.changes.outputs.docker == 'true' && github.event_name == 'pull_request'
        run: |
          python .github/scripts/trivy_gate.py --report trivy-pr.json --fail-on HIGH,CRITICAL

      - name: Upload Trivy SARIF (PR) / ä¸Šä¼  Trivy SARIFï¼ˆPRï¼‰
        if: always() && needs.changes.outputs.docker == 'true' && github.event_name == 'pull_request'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-pr.sarif

      - name: Upload Trivy report (PR) / ä¸Šä¼  Trivy æŠ¥å‘Šï¼ˆPRï¼‰
        if: always() && needs.changes.outputs.docker == 'true' && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: trivy-pr-report
          path: |
            trivy-pr.json
            trivy-pr.sarif
          if-no-files-found: warn

      - name: Validate requirements files / éªŒè¯ requirements æ–‡ä»¶
        if: needs.changes.outputs.docker == 'true'
        working-directory: docker/atlas
        run: |
          set -e
          for req in requirements*.txt; do
            echo "Checking $req..."
            if [ -f "$req" ]; then
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å†…å®¹
              if [ ! -s "$req" ]; then
                echo "Error: $req is empty"
                exit 1
              fi
              # æ£€æŸ¥åŸºæœ¬æ ¼å¼
              line_count=$(wc -l < "$req")
              echo "$req: $line_count packages"
            fi
          done
          echo "All requirements files validated"

  tests:
    needs: [changes]
    runs-on: ubuntu-latest
    if: needs.changes.outputs.code == 'true' || startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        python-version: ['3.12']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python / é…ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install test dependencies / å®‰è£…æµ‹è¯•ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest==9.0.2 pytest-cov==5.0.0

      - name: Run unit tests / è¿è¡Œå•å…ƒæµ‹è¯•
        working-directory: docker/atlas
        run: |
          # æµ‹è¯•è„šæœ¬è¯­æ³•ï¼ˆä¸éœ€è¦ Docker é•œåƒï¼‰
          cd tests
          for test in test_*.sh; do
            if [ -f "$test" ]; then
              echo "Checking $test syntax..."
              bash -n "$test"
            fi
          done
          if command -v python3 &> /dev/null; then
            for test in test_*.py; do
              if [ -f "$test" ]; then
                echo "Checking $test syntax..."
                python3 -m py_compile "$test"
              fi
            done
          fi
          echo "All tests passed syntax check"

      - name: Run pytest (host) / è¿è¡Œ pytestï¼ˆå®¿ä¸»æœºï¼‰
        run: |
          pytest -q tests/unit

  # Release build and push / å‘å¸ƒæ„å»ºå’Œæ¨é€ï¼ˆä»…åœ¨ tag æ—¶ï¼‰
  release:
    runs-on: ubuntu-latest
    needs: [lint, tests]
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      actions: write
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Free up disk space / é‡Šæ”¾ç£ç›˜ç©ºé—´
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read VERSION / è¯»å–ç‰ˆæœ¬å·
        id: version
        run: echo "version=$(cat docker/atlas/VERSION)" >> "$GITHUB_OUTPUT"

      - name: Log in to GitHub Container Registry / ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata / æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Build and push base image / æ„å»ºå’Œæ¨é€åŸºç¡€é•œåƒ
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: docker/atlas
          file: docker/atlas/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_TIER=0
            ENABLE_MATERIALS=0
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha,scope=release
          cache-to: type=gha,mode=max,scope=release
          platforms: linux/amd64

      - name: Save image digest / ä¿å­˜é•œåƒæ‘˜è¦
        run: echo "${{ steps.docker_build.outputs.digest }}" > image-digest.txt

      - name: Upload image digest / ä¸Šä¼ é•œåƒæ‘˜è¦
        uses: actions/upload-artifact@v4
        with:
          name: release-image-digest
          path: image-digest.txt

      - name: Output release summary / è¾“å‡ºå‘å¸ƒæ‘˜è¦
        run: |
          echo "## ğŸš€ Release Summary / å‘å¸ƒæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Information / ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Tag**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`$(cat docker/atlas/VERSION)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: \`$(date -u +'%Y-%m-%d %H:%M:%S UTC')\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Information / é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`${{ env.REGISTRY }}/${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: " >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Digest**: \`${{ steps.docker_build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Commands / æ‹‰å–å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull by tag / é€šè¿‡æ ‡ç­¾æ‹‰å–" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Pull by digest (immutable) / é€šè¿‡æ‘˜è¦æ‹‰å–ï¼ˆä¸å¯å˜ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}@${{ steps.docker_build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security / å®‰å…¨" >> $GITHUB_STEP_SUMMARY
          echo "- Use digest for production deployments to ensure immutability" >> $GITHUB_STEP_SUMMARY
          echo "- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¯·ä½¿ç”¨æ‘˜è¦ä»¥ç¡®ä¿ä¸å¯å˜æ€§" >> $GITHUB_STEP_SUMMARY
