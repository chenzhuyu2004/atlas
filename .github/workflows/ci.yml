name: ATLAS CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'requirements*.txt'
      - '.github/workflows/**'
      - 'tests/**'
      - '*.sh'
      - 'scripts/**'
    tags:
      - 'v*'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  IMAGE_NAME: atlas
  REGISTRY: ghcr.io

jobs:
  # Fast checks for every PR/push / å¿«é€Ÿæ£€æŸ¥ï¼ˆæ¯æ¬¡ PR/pushï¼‰
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10', '3.12']
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python for pre-commit
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install pre-commit and hooks
        run: |
          pip install pre-commit
          pre-commit install-hooks

      - name: Run pre-commit on all files
        run: |
          if [ "${{ matrix.python-version }}" = "3.12" ]; then
            SKIP=shellcheck pre-commit run --all-files
          else
            pre-commit run --all-files
          fi

      - name: Smoke build Dockerfile / è½»é‡æ„å»ºæ ¡éªŒ
        run: |
          docker build --target smoke -t atlas:smoke .

      - name: Validate requirements files / éªŒè¯ requirements æ–‡ä»¶
        run: |
          set -e
          for req in requirements*.txt; do
            echo "Checking $req..."
            if [ -f "$req" ]; then
              # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å†…å®¹
              if [ ! -s "$req" ]; then
                echo "Error: $req is empty"
                exit 1
              fi
              # æ£€æŸ¥åŸºæœ¬æ ¼å¼
              line_count=$(wc -l < "$req")
              echo "$req: $line_count packages"
            fi
          done
          echo "All requirements files validated"

      - name: Run unit tests / è¿è¡Œå•å…ƒæµ‹è¯•
        run: |
          # æµ‹è¯•è„šæœ¬é€»è¾‘ï¼ˆä¸éœ€è¦ Docker é•œåƒï¼‰
          cd tests
          # æ£€æŸ¥æµ‹è¯•è„šæœ¬è¯­æ³•
          for test in test_*.sh; do
            if [ -f "$test" ]; then
              echo "Checking $test syntax..."
              bash -n "$test"
            fi
          done
          # æ£€æŸ¥ Python æµ‹è¯•æ–‡ä»¶è¯­æ³•
          if command -v python3 &> /dev/null; then
            for test in test_*.py; do
              if [ -f "$test" ]; then
                echo "Checking $test syntax..."
                python3 -m py_compile "$test"
              fi
            done
          fi
          echo "All tests passed syntax check"

  # Release build and push / å‘å¸ƒæ„å»ºå’Œæ¨é€ï¼ˆä»…åœ¨ tag æ—¶ï¼‰
  release:
    runs-on: ubuntu-latest
    needs: lint
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Free up disk space / é‡Šæ”¾ç£ç›˜ç©ºé—´
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read VERSION / è¯»å–ç‰ˆæœ¬å·
        id: version
        run: echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry / ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata / æå–å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ github.repository }}
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}

      - name: Build and push base image / æ„å»ºå’Œæ¨é€åŸºç¡€é•œåƒ
        id: docker_build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            BUILD_TIER=0
            ENABLE_MATERIALS=0
            VERSION=${{ steps.version.outputs.version }}
          cache-from: type=gha,scope=release
          cache-to: type=gha,mode=max,scope=release
          platforms: linux/amd64

      - name: Output release summary / è¾“å‡ºå‘å¸ƒæ‘˜è¦
        run: |
          echo "## ğŸš€ Release Summary / å‘å¸ƒæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Information / ç‰ˆæœ¬ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Git Tag**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: \`$(cat VERSION)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: \`$(date -u +'%Y-%m-%d %H:%M:%S UTC')\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Information / é•œåƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry**: \`${{ env.REGISTRY }}/${{ github.repository }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags**: " >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Digest**: \`${{ steps.docker_build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pull Commands / æ‹‰å–å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull by tag / é€šè¿‡æ ‡ç­¾æ‹‰å–" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}:${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Pull by digest (immutable) / é€šè¿‡æ‘˜è¦æ‹‰å–ï¼ˆä¸å¯å˜ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ github.repository }}@${{ steps.docker_build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security / å®‰å…¨" >> $GITHUB_STEP_SUMMARY
          echo "- Use digest for production deployments to ensure immutability" >> $GITHUB_STEP_SUMMARY
          echo "- ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è¯·ä½¿ç”¨æ‘˜è¦ä»¥ç¡®ä¿ä¸å¯å˜æ€§" >> $GITHUB_STEP_SUMMARY
